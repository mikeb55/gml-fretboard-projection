<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fretboard UI v0.1 - Labyrinth Visualiser</title>
  <link rel="icon" type="image/svg+xml" href="../favicon.svg">
  <link rel="alternate icon" type="image/png" href="../favicon.png">
  <link rel="stylesheet" href="../src/fretboard-ui-styles.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .demo-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .demo-title {
      text-align: center;
      margin-bottom: 30px;
      color: #333;
    }
    
    .demo-title h1 {
      margin: 0 0 10px 0;
      font-size: 28px;
    }
    
    .demo-title p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    
    .overlay-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
      padding: 15px;
      background: #fafafa;
      border-radius: 8px;
    }
    
    .overlay-controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .overlay-controls input[type="checkbox"] {
      cursor: pointer;
    }
    
    .input-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .input-section label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #333;
    }
    
    .input-section textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .input-section button:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="demo-container">
    <div class="demo-title">
      <h1>Fretboard UI v0.1</h1>
      <p>Labyrinth-style Visualiser — Shows projection layer output</p>
    </div>
    
    <div class="input-section">
      <h3 style="margin-top: 0;">Input Method</h3>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Option 1: Upload iReal Pro Screenshot</label>
        <input type="file" id="image-upload" accept="image/*" style="margin-bottom: 10px;">
        <button id="analyze-image-btn" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">Analyze Image</button>
        <div id="image-analysis-result" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border: 1px solid #4caf50; border-radius: 4px; display: none;"></div>
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Option 2: Paste Chord Progression Text</label>
        <textarea id="chord-input">Bb7 | % | Eb7 | F7 | Bb7 | % | Eb7 | Bb7 | Gm7 | Cm7 | F7 | Bb7 | Eb7 | Edim7 | Bb7/G7 | Cm7/F7</textarea>
        <button id="parse-btn" style="margin-top: 10px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">Load Progression</button>
      </div>
      
      <div id="bar-count-warning" style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; display: none; color: #856404;"></div>
    </div>
    
    <div id="fretboard-container" class="fretboard-container"></div>
    
    <div class="overlay-controls">
      <label>
        <input type="checkbox" id="show-bar-number">
        Show Bar Number
      </label>
      <label>
        <input type="checkbox" id="show-movement-type">
        Show Movement Type
      </label>
      <label>
        <input type="checkbox" id="show-reason-codes">
        Show Reason Codes
      </label>
    </div>
  </div>

  <script type="module">
    import { FretboardUI } from '../src/fretboard-ui-v0.1.js';
    import { FretboardProjection } from '../src/fretboard-projection-v0.1.3.js';
    import { parseChordProgression } from '../src/chord-symbol-parser.js';
    import { detectBarCountFromChart } from '../src/chart-bar-detector.js';
    
    // Use actual projection layer to generate sample data with midiNotes
    const projection = new FretboardProjection();
    
    // NO 4-BAR DEMO - Removed to prevent any confusion or accidental loading
    
    const container = document.getElementById('fretboard-container');
    const ui = new FretboardUI(container, {
      showBarNumber: true,  // Show bar number by default
      showMovementType: false,
      showReasonCodes: false
    });
    
    // Function to load bars from engine outputs with explicit verification
    function loadBarsFromEngineOutputs(engineOutputs) {
      if (!engineOutputs || engineOutputs.length === 0) {
        console.error('ERROR: No engine outputs provided to loadBarsFromEngineOutputs');
        alert('Error: No chords to load');
        return;
      }
      
      const projectionOutputs = engineOutputs.map(output => projection.project(output));
      
      // CRITICAL VERIFICATION: Check if we accidentally got 4 bars
      if (projectionOutputs.length === 4) {
        const warningEl = document.getElementById('bar-count-warning');
        warningEl.textContent = `⚠️ WARNING: Only 4 bars detected! This may indicate a problem. Expected more bars from the progression.`;
        warningEl.style.display = 'block';
        console.error('⚠️ WARNING: Only 4 bars loaded - this may indicate a bug!');
      } else {
        const warningEl = document.getElementById('bar-count-warning');
        warningEl.style.display = 'none';
      }
      
      ui.loadBars(projectionOutputs);
      
      // Verify the UI actually has the correct number of bars
      setTimeout(() => {
        if (ui.bars.length !== projectionOutputs.length) {
          console.error(`CRITICAL BUG: UI bars.length (${ui.bars.length}) != projectionOutputs.length (${projectionOutputs.length})`);
          alert(`CRITICAL BUG DETECTED: UI has ${ui.bars.length} bars but should have ${projectionOutputs.length} bars!`);
        } else {
          console.log(`✓ VERIFIED: UI loaded with ${ui.bars.length} bars (matches projection outputs)`);
        }
      }, 100);
      
      console.log(`UI loaded with ${projectionOutputs.length} bars`);
    }
    
    // Parse button handler
    const parseBtn = document.getElementById('parse-btn');
    const chordInput = document.getElementById('chord-input');
    
    // Function to parse and load progression - CRITICAL: Must always load ALL bars, never limit to 4
    function parseAndLoadProgression() {
      const text = chordInput.value.trim();
      console.log('=== PARSING PROGRESSION ===');
      console.log('Input text:', text);
      
      if (!text) {
        console.warn('No chord progression entered - using default');
        // Use the pre-loaded textarea value as fallback
        const defaultText = chordInput.getAttribute('value') || chordInput.defaultValue || '';
        if (defaultText) {
          chordInput.value = defaultText;
          return parseAndLoadProgression(); // Retry with default
        }
        console.error('CRITICAL: No text available and no default found');
        return;
      }
      
      try {
        // Parse chord progression - this should return ALL chords, no limits
        const parsedChords = parseChordProgression(text);
        console.log(`✓ Parsed ${parsedChords.length} chords:`, parsedChords.map(c => c.symbol));
        
        if (parsedChords.length === 0) {
          console.error('CRITICAL ERROR: Parser returned 0 chords from:', text);
          alert('Error: Could not parse any chords from the input. Please check the format.');
          return;
        }
        
        // CRITICAL CHECK: If we only got 4 chords, warn the user
        if (parsedChords.length === 4) {
          console.warn('⚠️ WARNING: Parser returned exactly 4 chords. This may be correct, but verify the input contains all bars.');
        }
        
        // Generate projection outputs - map ALL chords, no slicing
        const engineOutputs = parsedChords.map((chord, index) => ({
          voicing: chord.voicing,
          inversion: 'root',
          registerPosition: 'mid',
          hold: index > 0, // Hold after first chord for smoother transitions
          reasonCodes: [{ code: 'PARSED_CHORD', message: `Parsed from: ${chord.symbol}` }]
        }));
        
        console.log(`✓ Generated ${engineOutputs.length} engine outputs (should match ${parsedChords.length} parsed chords)`);
        
        // CRITICAL: Verify we're passing ALL bars, not just 4
        if (engineOutputs.length !== parsedChords.length) {
          console.error(`CRITICAL BUG: engineOutputs.length (${engineOutputs.length}) != parsedChords.length (${parsedChords.length})`);
          alert(`CRITICAL BUG: Lost ${parsedChords.length - engineOutputs.length} bars during conversion!`);
        }
        
        // Load ALL bars - no limits
        loadBarsFromEngineOutputs(engineOutputs);
        
        console.log(`✓ SUCCESS: Loaded ${parsedChords.length} bars into UI`);
        console.log('=== PARSING COMPLETE ===');
      } catch (error) {
        console.error(`CRITICAL ERROR parsing chords:`, error);
        console.error('Error stack:', error.stack);
        alert(`Error parsing chords: ${error.message}\n\nCheck console for details.`);
      }
    }
    
    parseBtn.addEventListener('click', parseAndLoadProgression);
    
    // Auto-load the progression on page load - ensure DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM ready, auto-loading progression...');
        parseAndLoadProgression();
      });
    } else {
      // DOM already ready
      console.log('DOM already ready, auto-loading progression...');
      parseAndLoadProgression();
    }
    
    // NO DEMO BUTTON - Removed to prevent any 4-bar limit
    
    // Overlay toggles
    document.getElementById('show-bar-number').addEventListener('change', (e) => {
      ui.updateOptions({ showBarNumber: e.target.checked });
    });
    
    document.getElementById('show-movement-type').addEventListener('change', (e) => {
      ui.updateOptions({ showMovementType: e.target.checked });
    });
    
    document.getElementById('show-reason-codes').addEventListener('change', (e) => {
      ui.updateOptions({ showReasonCodes: e.target.checked });
    });
  </script>
</body>
</html>




